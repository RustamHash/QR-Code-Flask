{% extends "base.html" %}

{% block title %}–ó–∞–≥—Ä—É–∑–∏—Ç—å Excel - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –æ—Ñ–∏—Å–∞{% endblock %}

{% block content %}
<div class="card">
    <h2>üìä –ó–∞–≥—Ä—É–∑–∫–∞ Excel —Ñ–∞–π–ª–∞</h2>
    <p class="info-text">
        –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª (.xlsx –∏–ª–∏ .xls). –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø—Ä–æ—á–∏—Ç–∞–Ω—ã –∏–∑ –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ (–∫–æ–ª–æ–Ω–∫–∞ A),
        –Ω–∞—á–∏–Ω–∞—è —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏. –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –±—É–¥–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∞ –≤ —à–∞–±–ª–æ–Ω.
    </p>
</div>

<form method="POST" enctype="multipart/form-data" action="{{ url_for('upload_excel') }}" target="_blank">
    <div class="form-group">
        <label for="file">–í—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª:</label>
        <input type="file" id="file" name="file" accept=".xlsx,.xls" required>
    </div>
    
    <div class="form-group">
        <label for="excel_mode">–†–µ–∂–∏–º –æ–±—Ä–∞–±–æ—Ç–∫–∏:</label>
        <select id="excel_mode" name="excel_mode">
            <option value="one_column" {% if pdf_settings.excel_mode == 'one_column' %}selected{% endif %}>–û–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ (A) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º</option>
            <option value="two_columns" {% if pdf_settings.excel_mode == 'two_columns' %}selected{% endif %}>–î–≤–µ –∫–æ–ª–æ–Ω–∫–∏ (A –∏ B) - —à–∞–±–ª–æ–Ω—ã —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞</option>
        </select>
        <p style="color: #666; font-size: 0.9em; margin-top: 5px;">
            –í —Ä–µ–∂–∏–º–µ "–î–≤–µ –∫–æ–ª–æ–Ω–∫–∏" —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç—Ä–æ–≥–æ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏.
        </p>
    </div>
    
    <input type="hidden" id="width" name="width" value="{{ pdf_settings.width }}">
    <input type="hidden" id="height" name="height" value="{{ pdf_settings.height }}">
    <input type="hidden" id="rows" name="rows" value="{{ pdf_settings.rows_per_page }}">
    <input type="hidden" id="columns" name="columns" value="{{ pdf_settings.columns_per_page }}">
    
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettingsModal()">&times;</span>
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PDF</h2>
            <div id="settingsForm">
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="modal_width">–®–∏—Ä–∏–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–º–º):</label>
                        <input type="number" id="modal_width" value="{{ pdf_settings.width }}" min="10" max="1000" step="0.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="modal_height">–í—ã—Å–æ—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–º–º):</label>
                        <input type="number" id="modal_height" value="{{ pdf_settings.height }}" min="10" max="1000" step="0.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="modal_rows">–°—Ç—Ä–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                        <input type="number" id="modal_rows" value="{{ pdf_settings.rows_per_page }}" min="1" max="50" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="modal_columns">–ö–æ–ª–æ–Ω–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                        <input type="number" id="modal_columns" value="{{ pdf_settings.columns_per_page }}" min="1" max="10" required>
                    </div>
                </div>
                <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                    <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –í —Ä–µ–∂–∏–º–µ "–î–≤–µ –∫–æ–ª–æ–Ω–∫–∏" –ø–∞—Ä–∞–º–µ—Ç—Ä "–ö–æ–ª–æ–Ω–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ" –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–≤—Å–µ–≥–¥–∞ 2).
                </p>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="button" class="btn" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <div>
            <button type="submit" class="btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF —à–∞–±–ª–æ–Ω</button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary" style="margin-left: 10px;">–ù–∞–∑–∞–¥</a>
        </div>
        <button type="button" class="btn btn-secondary" onclick="openSettingsModal()">
            ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PDF
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    let currentSettings = {
        width: {{ pdf_settings.width }},
        height: {{ pdf_settings.height }},
        rows_per_page: {{ pdf_settings.rows_per_page }},
        columns_per_page: {{ pdf_settings.columns_per_page }}
    };
    
    function openSettingsModal() {
        document.getElementById('settingsModal').classList.add('active');
        document.getElementById('modal_width').value = currentSettings.width;
        document.getElementById('modal_height').value = currentSettings.height;
        document.getElementById('modal_rows').value = currentSettings.rows_per_page;
        document.getElementById('modal_columns').value = currentSettings.columns_per_page;
    }
    
    function closeSettingsModal() {
        document.getElementById('settingsModal').classList.remove('active');
    }
    
    function saveSettings() {
        const width = parseFloat(document.getElementById('modal_width').value);
        const height = parseFloat(document.getElementById('modal_height').value);
        const rows = parseInt(document.getElementById('modal_rows').value);
        const columns = parseInt(document.getElementById('modal_columns').value);
        
        if (width < 10 || width > 1000 || height < 10 || height > 1000 || rows < 1 || rows > 50 || columns < 1 || columns > 10) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
            return;
        }
        
        fetch('{{ url_for("save_pdf_settings") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                width: width,
                height: height,
                rows_per_page: rows,
                columns_per_page: columns
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentSettings = { width, height, rows_per_page: rows, columns_per_page: columns };
                document.getElementById('width').value = width;
                document.getElementById('height').value = height;
                document.getElementById('rows').value = rows;
                document.getElementById('columns').value = columns;
                closeSettingsModal();
                alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
        });
    }
    
    window.onclick = function(event) {
        const modal = document.getElementById('settingsModal');
        if (event.target == modal) {
            closeSettingsModal();
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form[method="POST"]');
        const submitButton = form ? form.querySelector('button[type="submit"]') : null;
        
        if (form) {
            if (submitButton) {
                submitButton.addEventListener('click', function(e) {
                    const fileInput = document.getElementById('file');
                    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                        e.preventDefault();
                        return false;
                    }
                });
            }
            
            form.addEventListener('submit', function(e) {
                const fileInput = document.getElementById('file');
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                    e.preventDefault();
                    return false;
                }
                
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF...';
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    // (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
                    setTimeout(function() {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF —à–∞–±–ª–æ–Ω';
                        }
                    }, 2000);
                }
            });
        }
    });
</script>
{% endblock %}

